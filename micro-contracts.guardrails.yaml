# AI-Driven Development Guardrails Configuration for mdJournal
# 
# This file defines which files can be modified in normal development PRs.
# Patterns use gitignore-style matching with glob patterns.
# Prefix with ! to negate (exclude) a pattern.

# Files that can be edited in normal development PRs
allowed:
  # OpenAPI specs (source of truth)
  - spec/**/openapi/*.yaml
  - spec/**/templates/*.hbs
  
  # Domain implementations (human-written)
  - server/src/**/domains/**/*.ts
  - server/src/**/*.ts
  - "!server/src/**/routes.generated.ts"
  
  # Client source files
  - client/src/**/*.ts
  - client/src/**/*.tsx
  - client/src/**/*.css
  - "!client/src/**/api.generated.ts"
  
  # Configuration files
  - micro-contracts.config.yaml
  - package.json
  - "*/package.json"
  - tsconfig.json
  - "*/tsconfig.json"
  - "**/tsconfig.*.json"
  - vite.config.ts
  - "**/vite.config.ts"
  - eslint.config.js
  - "**/eslint.config.js"
  - vitest.config.ts
  - "**/vitest.config.ts"
  
  # Test files
  - "**/*.test.ts"
  - "**/*.test.tsx"
  - "**/*.spec.ts"
  - "**/*.spec.tsx"
  
  # Documentation
  - docs/**/*.md
  - docs/**/*.html
  - README.md
  
  # Sample data
  - sample/**
  
  # Lock files and license
  - package-lock.json
  - "**/package-lock.json"
  - LICENSE

# Files that require special approval
protected:
  # This guardrails configuration
  - micro-contracts.guardrails.yaml
  
  # CI/workflow definitions
  - .github/**
  
  # Git configuration
  - .gitignore
  - .cursorrules

# Generated artifacts (committed, but only modified via generate)
generated:
  # Contract packages
  - packages/**
  
  # Generated files
  - "**/*.generated.ts"
  - "**/*.generated.yaml"
  - "**/*.generated.yml"

# Check command configurations
# Define custom commands for each guardrail check
#
# Gate 1: Change Allowlist
#   - allowlist (built-in): packages/** edit blocked, *.generated.* edit blocked
#
# Gate 2: OpenAPI Contract Validation (Spectral)
#   - spec-lint: Schema Validity
#
# Gate 3: Generated Artifact Integrity
#   - drift (built-in): git diff packages/**
#   - manifest (built-in): SHA-256 verification
#   - package-typecheck: Generated package type check
#
# Gate 4: Code Quality
#   - code-lint: TypeScript Lint (ESLint)
#   - code-typecheck: Type Check (tsc)
#   - code-test: Unit Tests
#
# Gate 5: Doc Consistency
#   - docs-sync: Documentation sync check

checks:
  # ==========================================
  # Gate 2: OpenAPI Contract Validation
  # ==========================================
  # Schema Validity check
  spec-lint:
    command: "npx @redocly/cli lint spec/mdjournal/openapi/mdjournal.yaml"
    gate: 2

  # ==========================================
  # Gate 3: Generated Artifact Integrity
  # ==========================================
  # drift, manifest are built-in checks (gate: 3)
  
  # Generated package type check
  package-typecheck:
    command: "cd packages/contract/mdjournal && npx tsc --noEmit"
    gate: 3

  # ==========================================
  # Gate 4: Code Quality
  # ==========================================
  # TypeScript Lint (ESLint)
  code-lint:
    command: "npm run lint --workspace=server && npm run lint --workspace=client"
    gate: 4
    enabled: false  # Enable when lint scripts are set up in workspaces
  
  # Type Check (tsc)
  code-typecheck:
    command: "npm run build:server -- --noEmit && cd client && npx tsc --noEmit"
    gate: 4
  
  # Unit Tests
  code-test:
    command: "npm test"
    gate: 4

  # ==========================================
  # Gate 5: Doc Consistency
  # ==========================================
  # Documentation check
  docs-sync:
    command: "echo 'Documentation sync check not implemented'"
    gate: 5
    enabled: false

